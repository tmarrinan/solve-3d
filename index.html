<!DOCTYPE html>
<html>
<head>
<title>3D Video Player</title>
<link rel="stylesheet" type="text/css" href="style.css" media="screen" />
<script type="text/javascript" src="scripts/glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="scripts/stereoVideoWebGL.js"></script>
<script type="text/javascript" src="scripts/stereoVideo2D.js"></script>
<script type="text/javascript" src="scripts/loadAnimation.js"></script>
<script type="text/javascript">
var supportsWebGL;
var videoCtxWebGL;
var videoCtx2D;
var myStereoVideoWebGL;
var myStereoVideo2D;
var stereoVideo;
var loadIcon;
var videoTime;
var videoAspect;
var videoStretch;
var disappearTimeout;
var videoLoaded;
var currentMode;
var currentFormat;
var seeking;
var wasPlaying;
var animationReq;
var animationTimeout;
var loadWithAnonymousURL;
var loadAnimationReq;
var nativeWidth;
var nativeHeight;

function init() {
	document.exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
	document.body.requestFullscreen = document.body.requestFullscreen || document.body.webkitRequestFullscreen || document.body.mozRequestFullScreen || document.body.msRequestFullscreen;

	videoAspect = 1.777777778;
	videoStretch = 1.0;
	supportsWebGL = false;
	videoCtxWebGL = videoCanvasWebGL.getContext('webgl') || videoCanvasWebGL.getContext('experimental-webgl');
	videoCtx2D = videoCanvas2D.getContext('2d');
	myStereoVideoWebGL = new stereoVideoWebGL(videoCtxWebGL);
	myStereoVideo2D = new stereoVideo2D(videoCtx2D);
	if (videoCtxWebGL !== undefined) {
		supportsWebGL = true;
		videoCanvas2D.style.display = "none";
	}
	else {
		videoCanvasWebGL.style.display = "none";
	}
	stereoVideo = null;

	loadIcon = new loadAnimation(loadingCanvas.getContext('2d'));

	videoLoaded = false;
	currentMode = "None";
	currentFormat = "Side-by-Side RL";
	seeking = false;
	wasPlaying = false;
	videoTime = 0;
	animationReq = null;
	animationTimeout = null;
	loadWithAnonymousURL = false;
	loadAnimationReq = null;

	menuTable.className = "fadeIn";
	stereoModeOptions.className = "fadeIn";
	stereoFormatOptions.className = "fadeIn";
	volumeSliderContainer.className = "fadeIn";
	videoControls.className = "fadeIn";
	disappearTimeout = setTimeout(function() {
		menuTable.className = "fadeOut";
		stereoModeOptions.className = "fadeOut";
		stereoFormatOptions.className = "fadeOut";
		volumeSliderContainer.className = "fadeOut";
		videoControls.className = "fadeOut";
		menuTable.style.opacity = 0.0;
		stereoModeOptions.style.opacity = 0.0;
		stereoFormatOptions.style.opacity = 0.0;
		volumeSliderContainer.style.opacity = 0.0;
		videoControls.style.opacity = 0.0;
		document.body.style.cursor = "none";
		disappearTimeout = null;
	}, 3000);

	var modeRect = stereoMode.getBoundingClientRect();
	stereoModeOptions.style.left = modeRect.left + "px";
	stereoModeOptions.style.top = modeRect.bottom + "px";
	stereoModeOptionsList.style.width = (modeRect.right-modeRect.left) + "px";
	var formatRect = stereoFormat.getBoundingClientRect();
	stereoFormatOptions.style.left = formatRect.left + "px";
	stereoFormatOptions.style.top = formatRect.bottom + "px";
	stereoFormatOptionsList.style.width = (formatRect.right-formatRect.left) + "px";
	var volumeRect = volume.getBoundingClientRect();
	volumeSliderContainer.style.left = (((volumeRect.left + volumeRect.right) / 2) - 21) + "px";
	volumeSliderContainer.style.top = volumeRect.bottom + "px";

	document.addEventListener('mousemove', mouseMove, false);
	openVideoFile.addEventListener('click', openVideoFileBrowser, false);
	openVideoUrl.addEventListener('click', openVideoUrlDialog, false);
	stereoMode.addEventListener('click', showStereoModeOptions, false);
	stereoModeOptions.addEventListener('click', changeStereoMode, false);
	stereoFormat.addEventListener('click', showStereoFormatOptions, false);
	stereoFormatOptions.addEventListener('click', changeStereoFormat, false);
	volume.addEventListener('click', showVolumeSliderContainer, false);
	volumeSlider.addEventListener('input', changeVideoVolume, false);

	videoControlsPlay.addEventListener('click', playVideo, false);
	videoControlsPause.addEventListener('click', pauseVideo, false);
	videoControlsSeek.addEventListener('mousedown', startVideoSeek, false);
	videoControlsSeek.addEventListener('input', videoSeeking, false);
	videoControlsSeek.addEventListener('mouseup', finishVideoSeek, false);
	videoControlsLoop.addEventListener('click', noLoopVideo, false);
	videoControlsNoLoop.addEventListener('click', loopVideo, false);
	videoControlsFullScreen.addEventListener('click', fullScreenVideo, false);
	
	videoFile.addEventListener('change', videoFileSelected, false);
	videoUrlDialogOpenBtn.addEventListener('click', videoUrlSelected, false);
	videoErrorDialogCloseBtn.addEventListener('click', videoErrorDialogClosed, false);
	video.addEventListener('error', videoError, false);
	video.addEventListener('loadedmetadata', videoMetaData, false);
	video.addEventListener('canplaythrough', videoCanPlayThrough, false);
	video.addEventListener('timeupdate', videoTimeUpdate, false);
	img.addEventListener('load', imageLoaded, false);

	resize();
}

function resize() {
	var winAspect = window.innerWidth / window.innerHeight;
	if (winAspect < videoAspect) {
		videoCanvasWebGL.width = window.innerWidth;
		videoCanvasWebGL.height = window.innerWidth / videoAspect;
		videoCanvasWebGL.style.marginLeft = "0px";
		videoCanvasWebGL.style.marginTop = parseInt((window.innerHeight - videoCanvasWebGL.height) / 2, 10) + "px";

		videoCanvas2D.width = window.innerWidth;
		videoCanvas2D.height = window.innerWidth / videoAspect;
		videoCanvas2D.style.marginLeft = "0px";
		videoCanvas2D.style.marginTop = parseInt((window.innerHeight - videoCanvas2D.height) / 2, 10) + "px";
	}
	else {
		videoCanvasWebGL.width = window.innerHeight * videoAspect;
		videoCanvasWebGL.height = window.innerHeight;
		videoCanvasWebGL.style.marginLeft = parseInt((window.innerWidth - videoCanvasWebGL.width) / 2, 10) + "px";
		videoCanvasWebGL.style.marginTop = "0px";

		videoCanvas2D.width = window.innerHeight * videoAspect;
		videoCanvas2D.height = window.innerHeight;
		videoCanvas2D.style.marginLeft = parseInt((window.innerWidth - videoCanvas2D.width) / 2, 10) + "px";
		videoCanvas2D.style.marginTop = "0px";
	}

	if (stereoVideo) stereoVideo.resize();
}

function mouseMove(event) {
	menuTable.className = "fadeIn";
	stereoModeOptions.className = "fadeIn";
	stereoFormatOptions.className = "fadeIn";
	volumeSliderContainer.className = "fadeIn";
	videoControls.className = "fadeIn";
	menuTable.style.opacity = 1.0;
	stereoModeOptions.style.opacity = 1.0;
	stereoFormatOptions.style.opacity = 1.0;
	volumeSliderContainer.style.opacity = 1.0;
	videoControls.style.opacity = 1.0;
	document.body.style.cursor = "default";
	if (disappearTimeout !== null) clearTimeout(disappearTimeout);
	disappearTimeout = setTimeout(function() {
		menuTable.className = "fadeOut";
		stereoModeOptions.className = "fadeOut";
		stereoFormatOptions.className = "fadeOut";
		volumeSliderContainer.className = "fadeOut";
		videoControls.className = "fadeOut";
		menuTable.style.opacity = 0.0;
		stereoModeOptions.style.opacity = 0.0;
		stereoFormatOptions.style.opacity = 0.0;
		volumeSliderContainer.style.opacity = 0.0;
		videoControls.style.opacity = 0.0;
		document.body.style.cursor = "none";
		disappearTimeout = null;
	}, 3000);
}

function openVideoFileBrowser(event) {
	var evt = document.createEvent("MouseEvents");
	evt.initMouseEvent("click", true, true, window, 0, event.screenX, event.screenY, event.clientX, event.cleintY, false, false, false, false, 0, null);
	videoFile.dispatchEvent(evt);
}

function openVideoUrlDialog(event) {
	videoUrlDialog.style.display = "block";
	videoUrlDialogText.value = "";
	videoUrlDialogText.focus();
}

function showStereoModeOptions(event) {
	if (stereoModeOptions.style.display !== "block")
		stereoModeOptions.style.display = "block";
	else
		stereoModeOptions.style.display = "none";
}

function changeStereoMode(event) {
	var i;
	var anaglyphRCImg1 = stereoModeAnaglyphRC.children[0];
	var anaglyphRCImg2 = stereoModeAnaglyphRC.children[1];
	var anaglyphGMImg1 = stereoModeAnaglyphGM.children[0];
	var anaglyphGMImg2 = stereoModeAnaglyphGM.children[1];

	if (event.target.id === "stereoModeAnaglyphRC") {
		if (stereoVideo instanceof stereoVideo2D) return;

		stereoModeAnaglyphRC.innerHTML = "&#x2713; Anaglyph";
		stereoModeAnaglyphGM.innerHTML = "&#x2751; Anaglyph";
		stereoModeInterleave.innerHTML = "&#x2751; Interleave";
		stereoModeLeftEye.innerHTML = "&#x2751; Left Eye";
		stereoModeRightEye.innerHTML = "&#x2751; Right Eye";
		stereoModeNone.innerHTML = "&#x2751; None";

		stereoModeAnaglyphRC.appendChild(anaglyphRCImg1);
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg2);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg1);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg2);

		if (currentFormat === "Side-by-Side RL") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-rl");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-rl");
		}
		else if (currentFormat === "Side-by-Side LR") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-lr");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-lr");
		}
		else if (currentFormat === "Top-Bottom RL") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-tb");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-tb");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-bt");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-bt");
		}

		currentMode = "anaglyph_rc";
	}
	else if (event.target.id === "stereoModeAnaglyphGM") {
		if (stereoVideo instanceof stereoVideo2D) return;

		stereoModeAnaglyphRC.innerHTML = "&#x2751; Anaglyph";
		stereoModeAnaglyphGM.innerHTML = "&#x2713; Anaglyph";
		stereoModeInterleave.innerHTML = "&#x2751; Interleave";
		stereoModeLeftEye.innerHTML = "&#x2751; Left Eye";
		stereoModeRightEye.innerHTML = "&#x2751; Right Eye";
		stereoModeNone.innerHTML = "&#x2751; None";
		
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg1);
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg2);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg1);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg2);

		if (currentFormat === "Side-by-Side RL") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-rl");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-rl");
		}
		else if (currentFormat === "Side-by-Side LR") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-lr");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-lr");
		}
		else if (currentFormat === "Top-Bottom RL") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-tb");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-tb");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-bt");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-bt");
		}

		currentMode = "anaglyph_gm";
	}
	else if (event.target.id === "stereoModeInterleave") {
		stereoModeAnaglyphRC.innerHTML = "&#x2751; Anaglyph";
		stereoModeAnaglyphGM.innerHTML = "&#x2751; Anaglyph";
		stereoModeInterleave.innerHTML = "&#x2713; Interleave";
		stereoModeLeftEye.innerHTML = "&#x2751; Left Eye";
		stereoModeRightEye.innerHTML = "&#x2751; Right Eye";
		stereoModeNone.innerHTML = "&#x2751; None";

		stereoModeAnaglyphRC.appendChild(anaglyphRCImg1);
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg2);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg1);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg2);

		if (currentFormat === "Side-by-Side RL") {
			myStereoVideoWebGL.updateStereoMode("interleave-rl");
			myStereoVideo2D.updateStereoMode("interleave-rl");
		}
		else if (currentFormat === "Side-by-Side LR") {
			myStereoVideoWebGL.updateStereoMode("interleave-lr");
			myStereoVideo2D.updateStereoMode("interleave-lr");
		}
		else if (currentFormat === "Top-Bottom RL") {
			myStereoVideoWebGL.updateStereoMode("interleave-tb");
			myStereoVideo2D.updateStereoMode("interleave-tb");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("interleave-bt");
			myStereoVideo2D.updateStereoMode("interleave-bt");
		}

		currentMode = "interleave";
	}
	else if (event.target.id === "stereoModeLeftEye") {
		stereoModeAnaglyphRC.innerHTML = "&#x2751; Anaglyph";
		stereoModeAnaglyphGM.innerHTML = "&#x2751; Anaglyph";
		stereoModeInterleave.innerHTML = "&#x2751; Interleave";
		stereoModeLeftEye.innerHTML = "&#x2713; Left Eye";
		stereoModeRightEye.innerHTML = "&#x2751; Right Eye";
		stereoModeNone.innerHTML = "&#x2751; None";

		stereoModeAnaglyphRC.appendChild(anaglyphRCImg1);
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg2);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg1);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg2);

		if (currentFormat === "Side-by-Side RL") {
			myStereoVideoWebGL.updateStereoMode("right");
			myStereoVideo2D.updateStereoMode("right");
		}
		else if (currentFormat === "Side-by-Side LR") {
			myStereoVideoWebGL.updateStereoMode("left");
			myStereoVideo2D.updateStereoMode("left");
		}
		else if (currentFormat === "Top-Bottom RL") {
			myStereoVideoWebGL.updateStereoMode("bottom");
			myStereoVideo2D.updateStereoMode("bottom");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("top");
			myStereoVideo2D.updateStereoMode("top");
		}

		currentMode = "leftEye";
	}
	else if (event.target.id === "stereoModeRightEye") {
		stereoModeAnaglyphRC.innerHTML = "&#x2751; Anaglyph";
		stereoModeAnaglyphGM.innerHTML = "&#x2751; Anaglyph";
		stereoModeInterleave.innerHTML = "&#x2751; Interleave";
		stereoModeLeftEye.innerHTML = "&#x2751; Left Eye";
		stereoModeRightEye.innerHTML = "&#x2713; Right Eye";
		stereoModeNone.innerHTML = "&#x2751; None";

		stereoModeAnaglyphRC.appendChild(anaglyphRCImg1);
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg2);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg1);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg2);

		if (currentFormat === "Side-by-Side RL") {
			myStereoVideoWebGL.updateStereoMode("left");
			myStereoVideo2D.updateStereoMode("left");
		}
		else if (currentFormat === "Side-by-Side LR") {
			myStereoVideoWebGL.updateStereoMode("right");
			myStereoVideo2D.updateStereoMode("right");
		}
		else if (currentFormat === "Top-Bottom RL") {
			myStereoVideoWebGL.updateStereoMode("top");
			myStereoVideo2D.updateStereoMode("top");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("bottom");
			myStereoVideo2D.updateStereoMode("bottom");
		}

		currentMode = "rightEye";
	}
	else {
		stereoModeAnaglyphRC.innerHTML = "&#x2751; Anaglyph";
		stereoModeAnaglyphGM.innerHTML = "&#x2751; Anaglyph";
		stereoModeInterleave.innerHTML = "&#x2751; Interleave";
		stereoModeLeftEye.innerHTML = "&#x2751; Left Eye";
		stereoModeRightEye.innerHTML = "&#x2751; Right Eye";
		stereoModeNone.innerHTML = "&#x2713; None";

		stereoModeAnaglyphRC.appendChild(anaglyphRCImg1);
		stereoModeAnaglyphRC.appendChild(anaglyphRCImg2);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg1);
		stereoModeAnaglyphGM.appendChild(anaglyphGMImg2);

		myStereoVideoWebGL.updateStereoMode("whole");
		myStereoVideo2D.updateStereoMode("whole");

		currentMode = "None";
	}

	if (videoLoaded === true) stereoVideo.draw();
}

function showStereoFormatOptions(event) {
	if (stereoFormatOptions.style.display !== "block")
		stereoFormatOptions.style.display = "block";
	else
		stereoFormatOptions.style.display = "none";
}

function changeStereoFormat(event) {
	var videoWidth;
	var videoHeight;

	if (event.target.id === "stereoFormatSideBySideRL") {
		stereoFormatSideBySideRL.innerHTML = "&#x2713; Side-by-Side RL";
		stereoFormatSideBySideLR.innerHTML = "&#x2751; Side-by-Side LR";
		stereoFormatTopBottomRL.innerHTML = "&#x2751; Top-Bottom RL";
		stereoFormatTopBottomLR.innerHTML = "&#x2751; Top-Bottom LR";

		if (currentMode === "anaglyph_rc") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-rl");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-rl");
		}
		else if (currentMode === "anaglyph_gm") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-rl");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-rl");
		}
		else if (currentMode === "interleave") {
			myStereoVideoWebGL.updateStereoMode("interleave-rl");
			myStereoVideo2D.updateStereoMode("interleave-rl");
		}
		else if (currentMode === "leftEye") {
			myStereoVideoWebGL.updateStereoMode("right");
			myStereoVideo2D.updateStereoMode("right");
		}
		else if (currentMode === "rightEye") {
			myStereoVideoWebGL.updateStereoMode("left");
			myStereoVideo2D.updateStereoMode("left");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("whole");
			myStereoVideo2D.updateStereoMode("whole");
		}

		if (videoLoaded === true && videoStretch === 2.0) {
			if (currentFormat === "Top-Bottom RL" || currentFormat === "Top-Bottom LR") {
				videoWidth = parseInt(nativeWidth / videoStretch, 10);
				videoHeight = nativeHeight;
				console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
				videoAspect = videoWidth / videoHeight;
				resize();
			}
		}

		currentFormat = "Side-by-Side RL";
	}
	else if (event.target.id === "stereoFormatSideBySideLR") {
		stereoFormatSideBySideRL.innerHTML = "&#x2751; Side-by-Side RL";
		stereoFormatSideBySideLR.innerHTML = "&#x2713; Side-by-Side LR";
		stereoFormatTopBottomRL.innerHTML = "&#x2751; Top-Bottom RL";
		stereoFormatTopBottomLR.innerHTML = "&#x2751; Top-Bottom LR";

		if (currentMode === "anaglyph_rc") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-lr");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-lr");
		}
		else if (currentMode === "anaglyph_gm") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-lr");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-lr");
		}
		else if (currentMode === "interleave") {
			myStereoVideoWebGL.updateStereoMode("interleave-lr");
			myStereoVideo2D.updateStereoMode("interleave-lr");
		}
		else if (currentMode === "leftEye") {
			myStereoVideoWebGL.updateStereoMode("left");
			myStereoVideo2D.updateStereoMode("left");
		}
		else if (currentMode === "rightEye") {
			myStereoVideoWebGL.updateStereoMode("right");
			myStereoVideo2D.updateStereoMode("right");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("whole");
			myStereoVideo2D.updateStereoMode("whole");
		}

		if (videoLoaded === true && videoStretch === 2.0) {
			if (currentFormat === "Top-Bottom RL" || currentFormat === "Top-Bottom LR") {
				videoWidth = parseInt(nativeWidth / videoStretch, 10);
				videoHeight = nativeHeight;
				console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
				videoAspect = videoWidth / videoHeight;
				resize();
			}
		}

		currentFormat = "Side-by-Side LR";
	}
	else if (event.target.id === "stereoFormatTopBottomRL") {
		stereoFormatSideBySideRL.innerHTML = "&#x2751; Side-by-Side RL";
		stereoFormatSideBySideLR.innerHTML = "&#x2751; Side-by-Side LR";
		stereoFormatTopBottomRL.innerHTML = "&#x2713; Top-Bottom RL";
		stereoFormatTopBottomLR.innerHTML = "&#x2751; Top-Bottom LR";

		if (currentMode === "anaglyph_rc") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-tb");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-tb");
		}
		else if (currentMode === "anaglyph_gm") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-tb");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-tb");
		}
		else if (currentMode === "interleave") {
			myStereoVideoWebGL.updateStereoMode("interleave-tb");
			myStereoVideo2D.updateStereoMode("interleave-tb");
		}
		else if (currentMode === "leftEye") {
			myStereoVideoWebGL.updateStereoMode("bottom");
			myStereoVideo2D.updateStereoMode("bottom");
		}
		else if (currentMode === "rightEye") {
			myStereoVideoWebGL.updateStereoMode("top");
			myStereoVideo2D.updateStereoMode("top");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("whole");
			myStereoVideo2D.updateStereoMode("whole");
		}

		if (videoLoaded === true && videoStretch === 2.0) {
			if (currentFormat === "Side-by-Side RL" || currentFormat === "Side-by-Side LR") {
				videoWidth = nativeWidth;
				videoHeight = parseInt(nativeHeight / videoStretch, 10);
				console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
				videoAspect = videoWidth / videoHeight;
				resize();
			}
		}

		currentFormat = "Top-Bottom RL";
	}
	else if (event.target.id === "stereoFormatTopBottomLR") {
		stereoFormatSideBySideRL.innerHTML = "&#x2751; Side-by-Side RL";
		stereoFormatSideBySideLR.innerHTML = "&#x2751; Side-by-Side LR";
		stereoFormatTopBottomRL.innerHTML = "&#x2751; Top-Bottom RL";
		stereoFormatTopBottomLR.innerHTML = "&#x2713; Top-Bottom LR";

		if (currentMode === "anaglyph_rc") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_rc-bt");
			//myStereoVideo2D.updateStereoMode("anaglyph_rc-bt");
		}
		else if (currentMode === "anaglyph_gm") {
			myStereoVideoWebGL.updateStereoMode("anaglyph_gm-bt");
			//myStereoVideo2D.updateStereoMode("anaglyph_gm-bt");
		}
		else if (currentMode === "interleave") {
			myStereoVideoWebGL.updateStereoMode("interleave-bt");
			myStereoVideo2D.updateStereoMode("interleave-bt");
		}
		else if (currentMode === "leftEye") {
			myStereoVideoWebGL.updateStereoMode("top");
			myStereoVideo2D.updateStereoMode("top");
		}
		else if (currentMode === "rightEye") {
			myStereoVideoWebGL.updateStereoMode("bottom");
			myStereoVideo2D.updateStereoMode("bottom");
		}
		else {
			myStereoVideoWebGL.updateStereoMode("whole");
			myStereoVideo2D.updateStereoMode("whole");
		}

		if (videoLoaded === true && videoStretch === 2.0) {
			if (currentFormat === "Side-by-Side RL" || currentFormat === "Side-by-Side LR") {
				videoWidth = nativeWidth;
				videoHeight = parseInt(nativeHeight / videoStretch, 10);
				console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
				videoAspect = videoWidth / videoHeight;
				resize();
			}
		}

		currentFormat = "Top-Bottom LR";
	}
	// stretch formats
	else if (event.target.id === "stereoFormatNativeResolution") {
		videoStretch = 1.0;

		stereoFormatNativeResolution.innerHTML = "&#x2713; Native Resolution";
		stereoFormat2XResolution.innerHTML = "&#x2751; 2X Resolution";

		if (videoLoaded === true) {
			if (currentFormat === "Side-by-Side RL" || currentFormat === "Side-by-Side LR") {
				videoWidth = parseInt(nativeWidth / videoStretch, 10);
				videoHeight = nativeHeight;
			}
			else {
				videoWidth = nativeWidth;
				videoHeight = parseInt(nativeHeight / videoStretch, 10);
			}
			console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
			videoAspect = videoWidth / videoHeight;
			resize();
		}
	}
	else if (event.target.id === "stereoFormat2XResolution") {
		videoStretch = 2.0;

		stereoFormatNativeResolution.innerHTML = "&#x2751; Native Resolution";
		stereoFormat2XResolution.innerHTML = "&#x2713; 2X Resolution";

		if (videoLoaded === true) {
			if (currentFormat === "Side-by-Side RL" || currentFormat === "Side-by-Side LR") {
				videoWidth = parseInt(nativeWidth / videoStretch, 10);
				videoHeight = nativeHeight;
			}
			else {
				videoWidth = nativeWidth;
				videoHeight = parseInt(nativeHeight / videoStretch, 10);
			}
			console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
			videoAspect = videoWidth / videoHeight;
			resize();
		}
	}

	if (videoLoaded === true) stereoVideo.draw();
}

function showVolumeSliderContainer(event) {
	if (volumeSliderContainer.style.display !== "block")
		volumeSliderContainer.style.display = "block";
	else
		volumeSliderContainer.style.display = "none";
}

function changeVideoVolume(event) {
	video.volume = parseInt(volumeSlider.value, 10) / 100;
}

function playVideo(event) {
	if (videoLoaded === true) {
		videoControlsPlay.style.display = "none";
		videoControlsPause.style.display = "block";
		if (animationReq === null) {
			animationReq = requestAnimationFrame(animateVideo);
		}
		video.play();
	}
}

function pauseVideo(event) {
	if (videoLoaded === true) {
		videoControlsPlay.style.display = "block";
		videoControlsPause.style.display = "none";
		if (animationTimeout !== null) {
			clearTimeout(animationTimeout);
			animationTimeout = null;
		}
		if (animationReq !== null) {
			cancelAnimationFrame(animationReq);
			animationReq = null;
		}
		video.pause();
	}
}

function startVideoSeek(event) {
	if (videoLoaded === true) {
		seeking = true;
		wasPlaying = !video.paused;
		if (wasPlaying === true) {
			pauseVideo(event);
		}
	}
}

function videoSeeking(event) {
	if (videoLoaded === true && seeking === true) {
		videoControlsTime.textContent = secondsToHMMSS((videoControlsSeek.value / 1000.0) * video.duration);
	}
}

function finishVideoSeek(event) {
	if (videoLoaded === true && seeking === true) {
		seeking = false;
		video.currentTime = (videoControlsSeek.value / 1000.0) * video.duration;
		if (wasPlaying === true) {
			playVideo(event);
		}
	}
}

function loopVideo(event) {
	if (videoLoaded === true) {
		videoControlsLoop.style.display = "block";
		videoControlsNoLoop.style.display = "none";
		video.loop = true;
	}
}

function noLoopVideo(event) {
	if (videoLoaded === true) {
		videoControlsLoop.style.display = "none";
		videoControlsNoLoop.style.display = "block";
		video.loop = false;
	}
}

function fullScreenVideo(event) {
	var fsElement = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
	if (fsElement === document.body) {
		document.exitFullscreen();
	}
	else {
		document.body.requestFullscreen();
	}
}

function videoFileSelected(event) {
	if (event.target.files.length > 0) {
		var ext = event.target.files[0].name.substring(event.target.files[0].name.lastIndexOf("."), event.target.files[0].name.length);
		var videoTypes = [
			"video/mp4",
			"video/webm"
		];
		var imageTypes = [
			"image/jpeg",
			"image/png"
		];

		if (videoTypes.indexOf(event.target.files[0].type) >= 0 || imageTypes.indexOf(event.target.files[0].type) >= 0 || ext === ".jps" || ext === ".pns") {
			if (animationTimeout !== null) {
				clearTimeout(animationTimeout);
				animationTimeout = null;
			}
			if (animationReq !== null) {
				cancelAnimationFrame(animationReq);
				animationReq = null;
			}

			if (supportsWebGL === true) {
				stereoVideo = myStereoVideoWebGL;
				videoCanvasWebGL.style.display = "block";
				videoCanvas2D.style.display = "none";
				stereoModeAnaglyphRC.setAttribute("active", true);
				stereoModeAnaglyphGM.setAttribute("active", true);
			}
			else {
				stereoVideo = myStereoVideo2D;
				videoCanvasWebGL.style.display = "none";
				videoCanvas2D.style.display = "block";
				stereoModeAnaglyphRC.setAttribute("active", false);
				stereoModeAnaglyphGM.setAttribute("active", false);
			}

			videoLoaded = false;
			startLoadAnimation();

			if (videoTypes.indexOf(event.target.files[0].type) >= 0) {
				loadWithAnonymousURL = false;
				video.src = window.URL.createObjectURL(event.target.files[0]);;
			}
			else {
				if (video.paused !== true) video.pause();
				img.src = window.URL.createObjectURL(event.target.files[0]);
			}
		}
		else {
			loadWithAnonymousURL = false;
			videoError(event);
		}
	}
}

function videoUrlSelected(event) {
	if (videoUrlDialogText.value !== "") {
		if (animationTimeout !== null) {
			clearTimeout(animationTimeout);
			animationTimeout = null;
		}
		if (animationReq !== null) {
			cancelAnimationFrame(animationReq);
			animationReq = null;
		}

		if (supportsWebGL === true) {
			stereoVideo = myStereoVideoWebGL;
			videoCanvasWebGL.style.display = "block";
			videoCanvas2D.style.display = "none";
			stereoModeAnaglyphRC.setAttribute("active", true);
			stereoModeAnaglyphGM.setAttribute("active", true);
		}
		else {
			stereoVideo = myStereoVideo2D;
			videoCanvasWebGL.style.display = "none";
			videoCanvas2D.style.display = "block";
			stereoModeAnaglyphRC.setAttribute("active", false);
			stereoModeAnaglyphGM.setAttribute("active", false);
		}

		startLoadAnimation();

		videoLoaded = false;
		loadWithAnonymousURL = true;
		var videoURL = videoUrlDialogText.value;
		video.crossOrigin = "anonymous";
		video.src = videoURL;
	}
	videoUrlDialog.style.display = "none";
}

function videoErrorDialogClosed(event) {
	videoErrorDialog.style.display = "none";
}

function videoError(event) {
	if (loadWithAnonymousURL === true) {
		video.removeAttribute("crossOrigin");
		video.src = videoUrlDialogText.value;
		loadWithAnonymousURL = false;

		stereoVideo = myStereoVideo2D;
		videoCanvasWebGL.style.display = "none";
		videoCanvas2D.style.display = "block";
		console.log("WARNING: Cross-Origin Video not supported in WebGL. Using 2D Canvas instead.");
		stereoModeAnaglyphRC.setAttribute("active", false);
		stereoModeAnaglyphGM.setAttribute("active", false);
	}
	else {
		stopLoadAnimation();

		videoErrorDialog.style.display = "block";
	}
}

function videoMetaData(event) {
	if (event.target.id === "video") {
		nativeWidth = event.target.videoWidth;
		nativeHeight = event.target.videoHeight;
		console.log("Full video size: " + nativeWidth + "x" + nativeHeight);
		var videoWidth;
		var videoHeight;
		if (currentFormat === "Side-by-Side RL" || currentFormat === "Side-by-Side LR") {
			videoWidth = parseInt(nativeWidth / videoStretch, 10);
			videoHeight = nativeHeight;
		}
		else {
			videoWidth = nativeWidth;
			videoHeight = parseInt(nativeHeight / videoStretch, 10);
		}
		console.log("Rendered video size: " + videoWidth + "x" + videoHeight);
		videoAspect = videoWidth / videoHeight;
		videoControls.style.display = "block";
		changeStereoMode({target: {id: "stereoModeNone"}});
		resize();
	}
}

function videoCanPlayThrough(event) {
	if (event.target.id === "video") {
		if (videoLoaded === false) {
			stopLoadAnimation();
			videoLoaded = true;
			stereoVideo.initTextures(video);
			stereoVideo.draw();
			playVideo(event);
			
		}		
	}
}

function imageLoaded(event) {
	if (event.target.id === "img") {
		videoLoaded = true;
		stopLoadAnimation();

		nativeWidth = img.naturalWidth;
		nativeHeight = img.naturalHeight;
		console.log("Full video size: " + nativeWidth + "x" + nativeHeight);
		var imgWidth;
		var imgHeight;
		if (currentFormat === "Side-by-Side RL" || currentFormat === "Side-by-Side LR") {
			imgWidth = parseInt(nativeWidth / videoStretch, 10);
			imgHeight = nativeHeight;
		}
		else {
			imgWidth = nativeWidth;
			imgHeight = parseInt(nativeHeight / videoStretch, 10);
		}
		console.log("Rendered video size: " + imgWidth + "x" + imgHeight);
		videoAspect = imgWidth / imgHeight;
		videoControls.style.display = "none";
		changeStereoMode({target: {id: "stereoModeNone"}});
		resize();

		stereoVideo.initTextures(img);
		stereoVideo.draw();
	}
}

function startLoadAnimation() {
	loadAnimationReq = requestAnimationFrame(animateLoadIcon);
	loadingCanvas.style.display = "block";
}

function stopLoadAnimation() {
	if (loadAnimationReq !== null) cancelAnimationFrame(loadAnimationReq);
	loadIcon.stop();
	loadingCanvas.style.display = "none";
}

function animateLoadIcon(timestamp) {
	loadIcon.draw(timestamp);
	loadAnimationReq = requestAnimationFrame(animateLoadIcon);
}

function videoTimeUpdate(event) {
	if (event.target.id === "video") {
		if (video.paused === false) {
			videoControlsTime.textContent = secondsToHMMSS(event.target.currentTime);
			videoControlsSeek.value = parseInt(1000.0 * (event.target.currentTime / event.target.duration), 10);
		}
	}
}

function animateVideo(timestamp) {
	stereoVideo.updateTextures(video);
	stereoVideo.draw();

	var dt = Math.ceil(timestamp - videoTime);
	if (dt >= 33) {
		videoTime = timestamp;
		animationReq = requestAnimationFrame(animateVideo);
	}
	else {
		animationTimeout = setTimeout(function() {
			videoTime = timestamp;
			animationReq = requestAnimationFrame(animateVideo);
		}, 33-dt);
	}
}

function secondsToHMMSS(sec) {
	var totalSec = parseInt(sec, 10);
	var ss = totalSec % 60;
	var mm = parseInt(totalSec / 60, 10) % 60;
	var h = parseInt(totalSec / 3600, 10);

	return h + ":" + (mm < 10 ? "0" + mm : mm) + ":" + (ss < 10 ? "0" + ss : ss);
}

function allNonNullDict(dict) {
	var key;
	for (key in dict) {
		if (dict.hasOwnProperty(key)) {
			if (dict[key] === null) return false;
		}
	}
	return true;
}

function httpGet(url, callback) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onreadystatechange = function() {
		if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				callback(null, xhr.responseText);
			} else {
				callback("Error: File Not Found", null);
			}
		}
	};
	xhr.send();
}
</script>
</head>

<body onload="init()" onresize="resize()">
	<canvas id="videoCanvasWebGL"></canvas>
	<canvas id="videoCanvas2D"></canvas>
	<canvas id="loadingCanvas" width="200" height="200"></canvas>
	<div id="menu">
		<table id="menuTable">
			<tr>
				<td id="openVideoFile" class="videoMenuItem">
					<img class="videoMenuImage" src="images/open_video_file_glow.png" width="32" height="32">
					<span class="videoMenuText">Open [File]</span>
				</td>
				<td id="openVideoUrl" class="videoMenuItem">
					<img class="videoMenuImage" src="images/open_video_url_glow.png" width="32" height="32">
					<span class="videoMenuText">Open [URL]</span>
				</td>
				<td id="stereoMode" class="videoMenuItem">
					<img class="videoMenuImage" src="images/stereo_mode_glow.png" width="32" height="32">
					<span class="videoMenuText">Stereo Mode</span>
				</td>
				<td id="stereoFormat" class="videoMenuItem">
					<img class="videoMenuImage" src="images/stereo_format_glow.png" width="32" height="32">
					<span class="videoMenuText">Stereo Format</span>
				</td>
				<td id="volume" class="videoMenuItem">
					<img class="videoMenuImage" src="images/volume_glow.png" width="32" height="32">
					<span class="videoMenuText">Volume</span>
				</td>
			</tr>
		</table>
	</div>
	<div id="stereoModeOptions">
		<ul id="stereoModeOptionsList">
			<li id="stereoModeAnaglyphRC" class="videoMenuOptionsOdd">&#x2751; Anaglyph<img id="anaglyphRedCyanImg1" class="active" src="images/red-cyan.png" width="14" height="14"><img id="anaglyphRedCyanImg2" class="inactive" src="images/red-cyan_inactive.png" width="14" height="14"></li>
			<li id="stereoModeAnaglyphGM" class="videoMenuOptionsEven">&#x2751; Anaglyph<img id="anaglyphGreenMagentaImg1" class="active" src="images/green-magenta.png" width="14" height="14"><img id="anaglyphGreenMagentaImg2" class="inactive" src="images/green-magenta_inactive.png" width="14" height="14"></li>
			<li id="stereoModeInterleave" class="videoMenuOptionsOdd">&#x2751; Interleave</li>
			<li id="stereoModeLeftEye" class="videoMenuOptionsEven">&#x2751; Left Eye</li>
			<li id="stereoModeRightEye" class="videoMenuOptionsOdd">&#x2751; Right Eye</li>
			<li id="stereoModeNone" class="videoMenuOptionsEven">&#x2713; None</li>
		</ul>
	</div>
	<div id="stereoFormatOptions">
		<ul id="stereoFormatOptionsList">
			<li id="stereoFormatSideBySideRL" class="videoMenuOptionsOdd">&#x2713; Side-by-Side RL</li>
			<li id="stereoFormatSideBySideLR" class="videoMenuOptionsEven">&#x2751; Side-by-Side LR</li>
			<li id="stereoFormatTopBottomRL" class="videoMenuOptionsOdd">&#x2751; Top-Bottom RL</li>
			<li id="stereoFormatTopBottomLR" class="videoMenuOptionsEven">&#x2751; Top-Bottom LR</li>
			<li id="stereoFormatHorizontalLine" class="videoMenuOptionsOddNoHover"><hr></li>
			<li id="stereoFormatNativeResolution" class="videoMenuOptionsEven">&#x2713; Native Resolution</li>
			<li id="stereoFormat2XResolution" class="videoMenuOptionsOdd">&#x2751; 2X Resolution</li>
		</ul>
	</div>
	<div id="volumeSliderContainer">
		<input id="volumeSlider" type="range" min="0" max="100" step="1" value="100">
	</div>
	<div id="videoControls">
		<img id="videoControlsPlay" src="images/play_icon_glow.png" width="42" height="42">
		<img id="videoControlsPause" src="images/pause_icon_glow.png" width="42" height="42">
		<input id="videoControlsSeek" type="range" min="0" max="1000" step="1" value="0">
		<span id="videoControlsTime">0:00:00</span>
		<img id="videoControlsLoop" src="images/loop_icon_glow.png" width="42" height="42">
		<img id="videoControlsNoLoop" src="images/noloop_icon_glow.png" width="42" height="42">
		<img id="videoControlsFullScreen" src="images/fullscreen_icon_glow.png" width="42" height="42">
	</div>

	<div id="videoUrlDialog">
		<span id="videoUrlDialogLabel">URL:</span>
		<input id="videoUrlDialogText" type="text">
		<div id="videoUrlDialogOpenBtn">Open</div>
	</div>

	<div id="videoErrorDialog">
		<p id="videoErrorDialogError">Error: video could not be loaded.</p>
		<p id="videoErrorDialogExplanation">Ensure that you have selected a valid .mp4 or .webm file.</p>
		<p id="videoErrorDialogNote">*Note: URLs from certain domains are not able to be loaded.</p>
		<div id="videoErrorDialogCloseBtn">OK</div>
	</div>

	<input id="videoFile" type="file" name="videoFile">
	<video id="video"></video>
	<img id="img"></img>
</body>
</html>
